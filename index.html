<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>中文筆順圖小工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
    .character-container:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .stroke-image:hover { transform: scale(1.03); }
    .character-display { text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2); }
  </style>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <div class="min-h-screen py-8 px-4">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">中文筆順圖小工具</h1>
        <div class="mb-8">
          <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-grow">
              <input type="text" id="characterInput" placeholder="請輸入中文字或英文單字..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
            </div>
            <button id="generateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
              產生筆順圖
            </button>
          </div>
          <p class="text-sm text-gray-500 mt-2">提示：可輸入中文字或英文單字，系統會顯示建議詞語供選擇</p>
        </div>

        <div id="candidateWords" class="hidden mb-6 p-4 bg-yellow-50 rounded-lg"></div>
        <div id="loadingIndicator" class="hidden flex justify-center my-8">
          <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
        </div>

        <div id="resultContainer" class="hidden">
          <div class="mb-4 p-3 bg-indigo-50 rounded-lg">
            <p class="text-center text-indigo-700">點擊圖片可切換動畫/靜態筆順圖</p>
          </div>
          <div id="charactersContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let cedictData = [];
    const safeTranslation = str => /^[\u4e00-\u9fa5]{1,4}$/.test(str);

    document.addEventListener('DOMContentLoaded', async function () {
      const characterInput = document.getElementById('characterInput');
      const generateBtn = document.getElementById('generateBtn');
      const resultContainer = document.getElementById('resultContainer');
      const charactersContainer = document.getElementById('charactersContainer');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const candidateWords = document.getElementById('candidateWords');

      try {
        const res = await fetch('https://raw.githubusercontent.com/ashleych34/hanzi-tools/main/edu_cedict.json');
        const text = await res.text();
        cedictData = JSON.parse(text);
      } catch (err) {
        alert('詞庫載入失敗，請確認 JSON 檔是否可讀取');
        console.error(err);
      }

      generateBtn.addEventListener('click', processInput);
      characterInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') processInput();
      });

      async function processInput() {
        const input = characterInput.value.trim().toLowerCase();
        if (!input) return alert('請輸入中文字或英文單字');
        charactersContainer.innerHTML = '';
        candidateWords.innerHTML = '';
        candidateWords.classList.add('hidden');

        let matches = cedictData.filter(entry => entry.en.toLowerCase() === input);

        if (matches.length === 0 && /^[a-zA-Z]+$/.test(input)) {
          try {
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(input)}&langpair=en|zh-TW`);
            const data = await res.json();
            const translated = data?.responseData?.translatedText || '';
            if (translated && translated !== input && safeTranslation(translated)) {
              matches = [{ zh: translated, pinyin: '', en: input }];
            }
          } catch (err) {
            console.warn('MyMemory API error', err);
          }
        }

        if (matches.length > 0) {
          candidateWords.classList.remove('hidden');
          candidateWords.innerHTML = '<p class="mb-2 font-medium">請選擇想查詢的中文詞語：</p>';
          matches.forEach(entry => {
            const btn = document.createElement('button');
            const label = entry.pinyin ? `${entry.zh} (${entry.pinyin})` : `${entry.zh}`;
            btn.textContent = label;
            btn.className = 'inline-block bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded px-3 py-1 m-1';
            btn.onclick = () => showCharacters(entry.zh);
            candidateWords.appendChild(btn);
          });
        } else if (/^[a-zA-Z]+$/.test(input)) {
          alert('找不到對應的詞語');
        } else {
          showCharacters(input);
        }
      }

      async function showCharacters(text) {
        loadingIndicator.classList.remove('hidden');
        resultContainer.classList.add('hidden');
        charactersContainer.innerHTML = '';

        setTimeout(async () => {
          for (let char of text) {
            if (!/\p{Script=Han}/u.test(char)) continue;
            const unicode = char.codePointAt(0).toString(16).toLowerCase();
            const staticUrl = `https://www.twpen.com/bishun-number/${unicode}-number.png`;
            const animatedUrl = `https://www.twpen.com/bishun-animation/${unicode}-stroke-order.gif`;

            const container = document.createElement('div');
            container.className = 'character-container bg-white rounded-lg shadow-md p-4 flex flex-col items-center';

            let zhuyinText = '';
            try {
              const res = await fetch(`https://www.moedict.tw/uni/${encodeURIComponent(char)}`);
              const json = await res.json();
              const bopomofo = json.bopomofo || (json.heteronyms && json.heteronyms[0]?.bopomofo);
              if (bopomofo && bopomofo !== 'N/A') {
                zhuyinText = bopomofo;
              }
            } catch (err) {
              console.warn('注音查詢失敗', err);
            }

            const zhuyin = document.createElement('div');
            zhuyin.className = 'text-base text-pink-600 font-medium mb-1 h-6';
            zhuyin.textContent = zhuyinText || '';
            container.appendChild(zhuyin);

            const display = document.createElement('div');
            display.className = 'character-display text-4xl font-bold mb-1 text-indigo-800';
            display.textContent = char;
            container.appendChild(display);

            const img = document.createElement('img');
            img.src = staticUrl;
            img.className = 'stroke-image w-full h-auto rounded-md mb-2';
            img.alt = `${char} 筆順圖`;
            img.dataset.staticSrc = staticUrl;
            img.dataset.animatedSrc = animatedUrl;
            img.dataset.isAnimated = 'false';
            img.onclick = function () {
              const isAni = img.dataset.isAnimated === 'true';
              img.src = isAni ? staticUrl : animatedUrl;
              img.dataset.isAnimated = (!isAni).toString();
              status.textContent = isAni ? '靜態筆順圖' : '動畫筆順圖';
            };
            container.appendChild(img);

            const status = document.createElement('p');
            status.className = 'text-sm text-gray-500';
            status.textContent = '靜態筆順圖';
            container.appendChild(status);

            charactersContainer.appendChild(container);
          }

          loadingIndicator.classList.add('hidden');
          resultContainer.classList.remove('hidden');

          if (!charactersContainer.children.length) {
            const msg = document.createElement('div');
            msg.className = 'col-span-full text-center py-8 text-gray-500';
            msg.textContent = '沒有找到可顯示筆順的中文字';
            charactersContainer.appendChild(msg);
          }
        }, 400);
      }
    });
  </script>
</body>
</html>
